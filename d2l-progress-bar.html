<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../d2l-colors/d2l-colors.html">
<link rel="import" href="../d2l-fastdom-import/fastdom.html">

<!--
`d2l-progress-bar`
Polymer-based web component progress bar

@demo demo/d2l-progress-bar.html
-->
<dom-module id="d2l-progress-bar">
	<template strip-whitespace>
		<style>
			:host {
				background-color: var(--d2l-color-sylvite);
				display: block;
				overflow: hidden;
			}
			:host, .progress-bar {
				height: 4px;
			}
			.progress-bar {
				background-color: var(--d2l-progress-bar-primary-color, var(--d2l-color-corundum));
				transform: translate(-100%, 0);
				will-change: transform;
			}
			.determinate {
				transition: transform 50ms ease-out;
			}
			.indeterminate-in-progress {
				transition: transform 10s cubic-bezier(.16,1,.4,1);
				transform: translate(-1%, 0);
			}
			.indeterminate-complete {
				transition: transform 300ms ease-in;
				transform: translate(0%, 0);
			}
		</style>
		<div>
			<div id="progressBar" class="progress-bar"></div>
		</div>
	</template>
	<script>
		'use strict';

		(function() {
			const indeterminateStates = {
				RESET: 0,
				IN_PROGRESS: 1,
				COMPLETE: 2
			};

			Polymer({
				is: 'd2l-progress-bar',

				hostAttributes: {
					role: 'progressbar'
				},

				properties: {
					/**
					* Whether the progress bar should automatically begin loading. (indeterminate only)
					*/
					autostart: {
						type: Boolean,
						reflectToAttribute: true,
						value: false
					},
					/**
					* If true, indicates the process is indeterminate.
					*/
					indeterminate: {
						type: Boolean,
						reflectToAttribute: true,
						value: false
					},
					/**
					* Value which indicates the action is 100% complete. (determinate only)
					*/
					max: {
						type: Number,
						value: 1
					},
					/**
					* The current progress of the action. (determinate only)
					*/
					value: {
						type: Number,
						value: 0
					}
				},

				observers: [
					'_onConfigChanged(indeterminate, autostart)',
					'_onProgressChanged(value, max)'
				],

				ready: function() {
					this._progress = 0;
					this._indeterminateState = indeterminateStates.RESET;

					this._onTransitionEndEvent = this._onTransitionEndEvent.bind(this);

					this.$.progressBar.addEventListener('transitionend', this._onTransitionEndEvent);

					if (this.autostart && this.indeterminate) {
						this.start();
					}
				},

				/**
				* For indeterminate progress bars, starts or restarts the progress bar animation.
				*/
				start: function() {
					if (!this.indeterminate) {
						return;
					}

					this._setIndeterminateState(indeterminateStates.RESET);

					setTimeout(function() {
						if (this._indeterminateState === indeterminateStates.RESET) {
							this._setIndeterminateState(indeterminateStates.IN_PROGRESS);
						}
					}.bind(this), 100);

				},

				/**
				* For indeterminate progress bars, completes the progress bar animation, moving it quickly to 100%.
				*/
				finish: function() {
					this._setIndeterminateState(indeterminateStates.COMPLETE);
				},

				_setIndeterminateState: function(state) {
					if (!this.indeterminate) {
						return;
					}

					var inProgress = state === indeterminateStates.IN_PROGRESS;
					var complete = state === indeterminateStates.COMPLETE;

					this._indeterminateState = state;

					this.toggleClass('indeterminate-in-progress', inProgress, this.$.progressBar);
					this.toggleClass('indeterminate-complete', complete, this.$.progressBar);

					this._progress = 0;

					if (inProgress || complete) {
						this._progress = inProgress ? 99 : 100;
					}
				},

				_onConfigChanged: function(indeterminate, autostart) {
					const progressBar = this.$$('.progress-bar');

					this.toggleClass('determinate', !indeterminate, progressBar);

					if (indeterminate) {
						this.removeAttribute('aria-valuemax');
						this.removeAttribute('aria-valuenow');

						if (autostart) {
							this.start();
						}
					}
				},

				_onProgressChanged: function(value, max) {
					if (this.indeterminate) {
						return;
					}

					const progressBar = this.$$('.progress-bar');
					value = Math.min(value, max);

					this._progress = (value / max) * 100;

					fastdom.mutate(() => {
						progressBar.style.transform = 'translate(-' + (100 - this._progress) + '%,0)';
					});

					this.setAttribute('aria-valuemax', max);
					this.setAttribute('aria-valuenow', value);
				},

				_onTransitionEndEvent: function() {
					if (this._progress === 100) {
						// Ensure it stays visible for a moment if consumer is hiding on completion
						setTimeout(function() {
							this.dispatchEvent(new CustomEvent('d2l-progress-bar-animation-complete'));
						}.bind(this), 200);
					}
				}
			});
		})();
	</script>
</dom-module>
